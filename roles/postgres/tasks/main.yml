---
- name: Install postgres packages
  sudo: yes
  yum: >
    name={{ item }}
    state=present
  with_items:
    - python-psycopg2
    - postgresql-server
    - postgresql

- name: Init postgresql
  sudo: yes
  command: >
    service postgresql initdb
    creates=/var/lib/pgsql/data/postgresql.conf

- name: Update pg_hba.conf
  sudo: yes
  copy: >
    src=pg_hba.conf
    dest=/var/lib/pgsql/data/pg_hba.conf
    owner=postgres
    group=postgres
    mode=0640
  notify:
    - reload postgresql

- name: Start postgresql
  sudo: yes
  service: >
    name=postgresql
    enabled=yes
    state=started

# using `become_user` for the following is a workaround
# see https://github.com/ansible/ansible/issues/2107

- name: Add vecnet database
  become_user: postgres
  postgresql_db: name={{ vecnet_db_name }}

# the md5 hash is generated by $(printf "%s%s" password username | md5)

- name: Add vecnet db user
  become_user: postgres
  postgresql_user: >
    db={{ vecnet_db_name }}
    name=vecnet
    encrypted=yes
    password=md5{{ [vecnet_db_pass, "vecnet"]|join("")|hash('md5') }}
    priv=ALL

- name: Add discovery database
  become_user: postgres
  postgresql_db: name=discovery_db

- name: Add discovery db user
  become_user: postgres
  postgresql_user: >
    db=discovery_db
    name=discovery
    encrypted=yes
    password=md5{{ [discovery_db_pass, "discovery"]|join("")|hash('md5') }}
    priv=ALL

- name: Make fedora database
  become_user: postgres
  postgresql_db: name=fedora3

- name: Make fedora user
  become_user: postgres
  postgresql_user: >
    db=fedora3
    name=fedora
    encrypted=yes
    password=md5{{ [fedora_db_pass, "fedora"]|join("")|hash('md5') }}
    priv=ALL

